<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>GBL ‚Äî Resource Management Lite (Survival Mode)</title>
  <style>
    :root{
      --bg1:#070b16; --bg2:#082a3a;
      --ink:#eaf2ff; --muted:#a8b6d6;
      --line:rgba(255,255,255,.10);
      --card:rgba(255,255,255,.06);
      --shadow: 0 18px 50px rgba(0,0,0,.45);

      --good:#2ee59d; --bad:#ff5a7a; --warn:#ffd166;
      --accent:#5bd6ff; --accent2:#7c5cff;

      --radius:18px;
      --tap:56px;
    }

    *{box-sizing:border-box}
    body{
      margin:0; color:var(--ink);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 800px at 18% 10%, rgba(124,92,255,.22), transparent 55%),
        radial-gradient(1000px 700px at 85% 25%, rgba(91,214,255,.18), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100svh;
      overflow-x:hidden;
    }

    .wrap{max-width:760px;margin:0 auto;padding:16px 14px 24px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .head{
      padding:14px 14px 12px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.06), transparent);
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .ttl{font-weight:1000;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:13px;margin-top:2px;line-height:1.25}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      color:var(--muted);font-size:12px;
      user-select:none;
    }
    .badge b{color:var(--ink)}
    .body{padding:14px}

    button{
      height:var(--tap);padding:0 14px;border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--ink);font-weight:900;letter-spacing:.1px;
      cursor:pointer;transition:transform .08s ease, background .12s ease, border-color .12s ease;
      touch-action:manipulation;
    }
    button:active{transform:translateY(1px) scale(.99)}
    button:hover{background:rgba(255,255,255,.10)}
    button:disabled{opacity:.55;cursor:not-allowed}
    .primary{border-color:rgba(91,214,255,.35);background:linear-gradient(180deg, rgba(91,214,255,.24), rgba(124,92,255,.16))}
    .danger{border-color:rgba(255,90,122,.35);background:linear-gradient(180deg, rgba(255,90,122,.18), rgba(255,255,255,.05))}
    .soft{border-color:rgba(255,209,102,.25);background:linear-gradient(180deg, rgba(255,209,102,.14), rgba(255,255,255,.04))}

    .hud{
      padding:12px 14px 10px;
      border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.12);
    }
    .hudrow{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .healthWrap{flex:1;min-width:220px}
    .healthLabel{display:flex;justify-content:space-between;gap:10px;color:var(--muted);font-size:12px;margin-bottom:7px}
    .bar{
      height:14px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.04);overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.12);
    }
    .fill{
      height:100%;
      width:100%;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(46,229,157,.95), rgba(255,209,102,.95), rgba(255,90,122,.95));
      transform-origin:left;
      transform:scaleX(1);
      transition: transform 420ms ease;
    }
    .pulseGood{animation:pulseGood .35s ease}
    .pulseBad{animation:pulseBad .35s ease}
    @keyframes pulseGood{from{filter:brightness(1)}to{filter:brightness(1.2)}}
    @keyframes pulseBad{from{filter:brightness(1)}to{filter:brightness(.85)}}

    .qMeta{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
    .qText{
      font-size:clamp(18px,2.6vw,24px);
      line-height:1.22;font-weight:1000;letter-spacing:.15px;
      margin:0 0 12px 0;
    }
    .choices{display:grid;grid-template-columns:1fr;gap:10px}
    .choice{
      height:auto;min-height:60px;
      text-align:left;padding:12px 12px;border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      color:var(--ink);font-weight:850;line-height:1.25;
      cursor:pointer;
    }
    .choice:hover{background:rgba(255,255,255,.09)}
    .choice:disabled{cursor:not-allowed;opacity:.9}

    .feedback{
      margin-top:12px;
      padding:12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.14);
      display:none;
      gap:10px;align-items:flex-start;
    }
    .feedback.show{display:flex}
    .tag{
      min-width:92px;text-align:center;
      padding:10px 12px;border-radius:14px;
      border:1px solid var(--line);
      font-weight:1000;
      user-select:none;
    }
    .tag.good{background:rgba(46,229,157,.16);border-color:rgba(46,229,157,.35)}
    .tag.bad{background:rgba(255,90,122,.14);border-color:rgba(255,90,122,.30)}
    .ftext{color:var(--muted);font-size:13px;line-height:1.35}

    .tools{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-top:10px}
    .toolBtn{
      display:flex;gap:10px;align-items:center;justify-content:center;
      height:54px;min-width:170px;
    }
    .toolBtn small{color:var(--muted);font-weight:800}
    .toolBtn.used{opacity:.55}

    .hint{
      color:var(--muted);font-size:13px;line-height:1.35;
      padding:12px;border-radius:16px;border:1px solid var(--line);
      background:rgba(0,0,0,.14)
    }

    .overlay{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      padding:14px;background:rgba(0,0,0,.55);backdrop-filter:blur(8px);z-index:50;
    }
    .overlay.show{display:flex}
    .modal{
      width:min(640px,100%);
      border-radius:22px;border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(15,27,45,.98), rgba(10,16,32,.98));
      box-shadow:0 22px 70px rgba(0,0,0,.60);
      overflow:hidden;
    }
    .mhead{
      padding:14px;border-bottom:1px solid var(--line);
      display:flex;justify-content:space-between;gap:10px;align-items:flex-start;flex-wrap:wrap;
    }
    .mttl{font-weight:1000}
    .mbody{padding:14px}
    .mrow{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:12px}

    .screen{display:none}
    .screen.show{display:block}

    .shake{animation:shake .24s ease}
    @keyframes shake{
      0%{transform:translateX(0)}
      25%{transform:translateX(-4px)}
      50%{transform:translateX(4px)}
      75%{transform:translateX(-3px)}
      100%{transform:translateX(0)}
    }

    .toast{
      position:fixed;left:50%;bottom:16px;transform:translateX(-50%);
      display:none;z-index:60;max-width:min(720px,92vw);
      padding:12px 14px;border-radius:16px;border:1px solid var(--line);
      background:rgba(10,16,32,.88);color:var(--ink);
      box-shadow:0 22px 60px rgba(0,0,0,.55);backdrop-filter:blur(10px);
      font-weight:900;
    }
    .toast.show{display:block;animation:pop .18s ease}
    @keyframes pop{from{transform:translateX(-50%) translateY(10px);opacity:0}to{transform:translateX(-50%) translateY(0);opacity:1}}

    .settingsRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    input[type="range"]{width:100%}
    .mini{color:var(--muted);font-size:12px}
    .sp{height:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">

      <!-- INTRO -->
      <div class="screen" id="screenIntro">
        <div class="head">
          <div>
            <div class="ttl">System Security Challenge</div>
            <div class="sub">Survival mode: keep answering until your <b>System Health</b> reaches zero.</div>
          </div>
          <div class="badge">Session: <b id="sessId">UOU</b></div>
        </div>
        <div class="body">
          <div class="hint">
            <b>Rules</b><br/>
            ‚Ä¢ Correct: <b>+5</b> Health (max 100)<br/>
            ‚Ä¢ Wrong: <b>‚àí10</b> Health<br/>
            ‚Ä¢ One Repair Token: <b>+20</b> once<br/>
            ‚Ä¢ Questions continue until Health becomes <b>0</b><br/>
          </div>

          <div class="sp"></div>

          <div class="card" style="border-radius:16px;box-shadow:none;border:1px solid var(--line);background:rgba(0,0,0,.12)">
            <div class="body">
              <div class="settingsRow">
                <div style="font-weight:1000">Feedback reading delay</div>
                <div class="badge"><b id="delayLabel">1800</b>&nbsp;ms</div>
              </div>
              <div style="margin-top:10px">
                <input id="delayRange" type="range" min="1200" max="3500" step="100" value="1800" />
                <div class="mini" style="display:flex;justify-content:space-between;margin-top:6px">
                  <span>Slower (better for phones)</span><span>Faster</span>
                </div>
              </div>
            </div>
          </div>

          <div class="sp"></div>

          <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
            <button id="btnNew" class="soft">New Shuffle</button>
            <button id="btnStart" class="primary">Start</button>
          </div>
        </div>
      </div>

      <!-- GAME -->
      <div class="screen" id="screenGame">
        <div class="hud">
          <div class="hudrow">
            <div class="healthWrap">
              <div class="healthLabel">
                <span>System Health</span>
                <span><b id="healthPct">100%</b></span>
              </div>
              <div class="bar">
                <div class="fill" id="healthFill"></div>
              </div>
            </div>
            <div class="badge">Attempt <b id="attemptNo">1</b></div>
            <div class="badge">Correct <b id="correctNo">0</b></div>
          </div>
        </div>

        <div class="body" id="gameBody">
          <div class="qMeta">
            <div class="badge">Topic: <b>Windows & Account Security</b></div>
            <div class="badge">Repair: <b id="repairState">Available</b></div>
          </div>

          <p class="qText" id="qText">Question text</p>

          <div class="choices" id="choices"></div>

          <div class="feedback" id="feedback">
            <div class="tag" id="fbTag">‚Äî</div>
            <div class="ftext" id="fbText">‚Äî</div>
          </div>

          <div class="tools">
            <button id="btnRepair" class="toolBtn soft">
              üõ†Ô∏è Repair Token <small>(+20)</small>
            </button>

            <button id="btnReset" class="danger" title="Reset this session">Reset</button>
          </div>

          <div class="hint" style="margin-top:12px">
            Tip: In survival mode, play for longevity. Read the feedback before the next question appears.
          </div>
        </div>
      </div>

      <!-- END -->
      <div class="screen" id="screenEnd">
        <div class="head">
          <div>
            <div class="ttl" id="endTitle">System Compromised ‚ö†Ô∏è</div>
            <div class="sub" id="endSub">Health reached zero. Try again.</div>
          </div>
          <div class="badge">Final Health: <b id="endHealth">0%</b></div>
        </div>
        <div class="body">
          <div class="hint" id="endStats">
            Attempted: ‚Äî<br/>Correct: ‚Äî<br/>Longest streak: ‚Äî
          </div>

          <div class="sp"></div>

          <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
            <button id="btnAgain" class="primary">Play Again</button>
            <button id="btnBack" class="soft">Back to Start</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Repair Modal -->
  <div class="overlay" id="repairModal" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="mhead">
        <div>
          <div class="mttl">Use Repair Token?</div>
          <div class="sub" style="margin-top:4px">Restores <b>+20</b> Health. Can be used only once.</div>
        </div>
        <div class="badge">Now: <b id="repairNow">‚Äî</b></div>
      </div>
      <div class="mbody">
        <div class="hint">Recommended when Health is low (below ~40%).</div>
        <div class="mrow">
          <button id="btnRepairCancel">Cancel</button>
          <button id="btnRepairYes" class="primary">Yes, Use</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const params = new URLSearchParams(location.search);
    const pid = (params.get("pid") || "UOU").trim();
    document.getElementById("sessId").textContent = pid;
    const STORE_KEY = "UOU_RML_SURVIVAL_" + pid;

    // Replace/expand this bank later with your chapter-based MCQs
    const QUESTION_BANK = [
      {id:"Q1", q:"Which option during Windows setup helps you control privacy settings instead of accepting defaults?", c:["Express settings","Customise settings","Skip sign-in","Enable all sharing"], a:1, ex:"Customise settings lets you review and limit data-sharing options."},
      {id:"Q2", q:"Which feature helps protect users from malicious websites and downloads in Windows?", c:["Night Light","SmartScreen","Task View","Clipboard history"], a:1, ex:"SmartScreen checks reputation of sites/downloads to reduce exposure to threats."},
      {id:"Q3", q:"A quick way to lock your Windows device when stepping away is:", c:["Windows + L","Alt + Tab","Ctrl + S","Windows + D"], a:0, ex:"Windows + L locks the screen immediately."},
      {id:"Q4", q:"Why should file extensions be visible in Windows Explorer for security?", c:["It increases speed","It reduces RAM use","It helps detect disguised executables like .pdf.exe","It enables encryption"], a:2, ex:"Hidden extensions can hide real file types; showing them reduces tricking risk."},
      {id:"Q5", q:"Windows Firewall should normally be turned ON for:", c:["Only public networks","Only private networks","Both private and public networks","Only during downloads"], a:2, ex:"Firewall protection is recommended for both private and public networks."},
      {id:"Q6", q:"Disabling AutoPlay is recommended mainly because it:", c:["Improves display quality","Reduces malware risk from removable media auto-launch","Stops Windows updates","Disables Bluetooth"], a:1, ex:"AutoPlay can trigger risky actions when USB/media is inserted."},
      {id:"Q7", q:"Turning off which privacy permission reduces apps using your account details?", c:["Account info access","Screen brightness","Wi-Fi driver","System restore"], a:0, ex:"Disabling account info access limits apps from reading your account details."},
      {id:"Q8", q:"Keeping Windows updated is important mainly because updates:", c:["Disable antivirus","Patch known vulnerabilities","Make passwords unnecessary","Hide file extensions"], a:1, ex:"Updates commonly patch security vulnerabilities exploited by attackers."},
      {id:"Q9", q:"What is the main benefit of full-disk encryption (e.g., BitLocker)?", c:["Faster internet","Protection if someone accesses the disk physically","Better display colors","Automatic backups"], a:1, ex:"Encryption protects data at rest if the device/drive is stolen or accessed physically."},
      {id:"Q10", q:"When setting a password hint, it should:", c:["Contain your DOB","Be easy for others to guess","Not reveal sensitive clues about the password","Be the same as the password"], a:2, ex:"A password hint should not leak information that helps guessing."},
      {id:"Q11", q:"To reduce location tracking, a privacy-friendly step is to:", c:["Keep Location ON always","Turn Location OFF and clear location history","Enable location for all apps","Share location history"], a:1, ex:"Disabling location and clearing history reduces stored location records."},
      {id:"Q12", q:"To reduce unnecessary background activity, you should:", c:["Allow all background apps","Disable unnecessary background apps","Disable firewall","Enable all telemetry"], a:1, ex:"Turning off unnecessary background apps reduces background activity."}
    ];

    const el = (id)=>document.getElementById(id);

    const screenIntro = el("screenIntro");
    const screenGame  = el("screenGame");
    const screenEnd   = el("screenEnd");

    const delayRange = el("delayRange");
    const delayLabel = el("delayLabel");
    const btnStart = el("btnStart");
    const btnNew   = el("btnNew");

    const healthFill = el("healthFill");
    const healthPct  = el("healthPct");
    const attemptNo  = el("attemptNo");
    const correctNo  = el("correctNo");

    const qTextEl    = el("qText");
    const choicesEl  = el("choices");
    const feedbackEl = el("feedback");
    const fbTag      = el("fbTag");
    const fbText     = el("fbText");

    const repairStateEl = el("repairState");
    const btnRepair  = el("btnRepair");
    const btnReset   = el("btnReset");
    const gameBody   = el("gameBody");

    const repairModal = el("repairModal");
    const repairNow = el("repairNow");
    const btnRepairCancel = el("btnRepairCancel");
    const btnRepairYes = el("btnRepairYes");

    const endHealth = el("endHealth");
    const endStats  = el("endStats");
    const btnAgain  = el("btnAgain");
    const btnBack   = el("btnBack");

    const toast = el("toast");

    let state = loadState() || freshState();
    syncIntro();
    route();
    if (state.phase === "game") renderGame();
    if (state.phase === "end") renderEnd();

    delayRange.addEventListener("input", ()=>{
      state.delayMs = Number(delayRange.value);
      delayLabel.textContent = delayRange.value;
      saveState();
    });

    btnNew.addEventListener("click", ()=>{
      const keepDelay = state.delayMs ?? 1800;
      state = freshState();
      state.delayMs = keepDelay;
      saveState();
      syncIntro();
      showToast("New shuffle prepared.");
    });

    btnStart.addEventListener("click", ()=>{
      state.phase = "game";
      saveState();
      route();
      renderGame();
    });

    btnReset.addEventListener("click", ()=>{
      if (!confirm("Reset this session now?")) return;
      localStorage.removeItem(STORE_KEY);
      state = freshState();
      saveState();
      syncIntro();
      route();
      showToast("Session reset.");
    });

    btnRepair.addEventListener("click", ()=>{
      if (state.repairUsed || state.phase !== "game") return;
      openRepairModal();
    });

    btnRepairCancel.addEventListener("click", closeRepairModal);
    repairModal.addEventListener("click", (e)=>{ if (e.target === repairModal) closeRepairModal(); });

    btnRepairYes.addEventListener("click", ()=>{
      if (state.repairUsed) return;
      state.repairUsed = true;
      state.health = clamp(state.health + 20, 0, 100);
      closeRepairModal();
      saveState();
      animateHealth("good");
      renderHUD();
      renderRepair();
      showToast("Repair applied (+20).");
    });

    btnAgain.addEventListener("click", ()=>{
      const keepDelay = state.delayMs ?? 1800;
      state = freshState();
      state.delayMs = keepDelay;
      state.phase = "game";
      saveState();
      route();
      renderGame();
    });

    btnBack.addEventListener("click", ()=>{
      state.phase = "intro";
      saveState();
      route();
      syncIntro();
    });

    function freshState(){
      const order = shuffle([...Array(QUESTION_BANK.length)].map((_,i)=>i));
      return {
        pid,
        phase:"intro",
        delayMs:1800,
        health:100,
        repairUsed:false,
        attempted:0,
        correct:0,
        bestStreak:0,
        streak:0,
        // queue of question indices to pull from
        queue:order,
        // current question index in bank
        current:null
      };
    }

    function syncIntro(){
      delayRange.value = String(state.delayMs ?? 1800);
      delayLabel.textContent = delayRange.value;
    }

    function route(){
      screenIntro.classList.remove("show");
      screenGame.classList.remove("show");
      screenEnd.classList.remove("show");
      if (state.phase === "intro") screenIntro.classList.add("show");
      if (state.phase === "game")  screenGame.classList.add("show");
      if (state.phase === "end")   screenEnd.classList.add("show");
    }

    function renderGame(){
      renderHUD();
      renderRepair();
      nextQuestion();
    }

    function renderHUD(){
      const s = clamp(state.health, 0, 100) / 100;
      healthFill.style.transform = `scaleX(${s})`;
      healthPct.textContent = `${Math.round(state.health)}%`;
      attemptNo.textContent = String(state.attempted + 1); // upcoming attempt
      correctNo.textContent = String(state.correct);
    }

    function renderRepair(){
      if (state.repairUsed){
        repairStateEl.textContent = "Used";
        btnRepair.disabled = true;
        btnRepair.classList.add("used");
      } else {
        repairStateEl.textContent = "Available";
        btnRepair.disabled = false;
        btnRepair.classList.remove("used");
      }
    }

    function nextQuestion(){
      feedbackEl.classList.remove("show");
      fbTag.textContent = "‚Äî";
      fbTag.className = "tag";
      fbText.textContent = "‚Äî";
      choicesEl.innerHTML = "";

      // If queue is empty, reshuffle (so game can continue indefinitely)
      if (!state.queue || state.queue.length === 0){
        state.queue = shuffle([...Array(QUESTION_BANK.length)].map((_,i)=>i));
      }

      state.current = state.queue.shift();
      const q = QUESTION_BANK[state.current];

      qTextEl.textContent = q.q;

      q.c.forEach((txt, i)=>{
        const b = document.createElement("button");
        b.className = "choice";
        const label = String.fromCharCode(65 + i);
        b.innerHTML = `<div><b>${label}.</b> ${escapeHtml(txt)}</div>`;
        b.addEventListener("click", ()=>answer(i));
        choicesEl.appendChild(b);
      });

      saveState();
      renderHUD();
    }

    function answer(chosenIndex){
      [...choicesEl.querySelectorAll("button")].forEach(btn=>btn.disabled = true);

      const q = QUESTION_BANK[state.current];
      state.attempted += 1;

      const ok = (chosenIndex === q.a);

      if (ok){
        state.correct += 1;
        state.streak += 1;
        state.bestStreak = Math.max(state.bestStreak, state.streak);
        state.health = clamp(state.health + 5, 0, 100);
        showFeedback(true, q.ex);
        animateHealth("good");
      } else {
        state.streak = 0;
        state.health = clamp(state.health - 10, 0, 100);
        const correctLabel = String.fromCharCode(65 + q.a);
        const explain = `Correct: ${correctLabel}. ${q.c[q.a]} ‚Äî ${q.ex}`;
        showFeedback(false, explain);
        animateHealth("bad");
        tinyShake();
      }

      saveState();
      renderHUD();
      renderRepair();

      if (state.health <= 0){
        setTimeout(endGame, 450);
        return;
      }

      setTimeout(()=>{
        nextQuestion();
      }, Number(state.delayMs ?? 1800));
    }

    function endGame(){
      state.phase = "end";
      saveState();
      route();
      renderEnd();
    }

    function renderEnd(){
      endHealth.textContent = `${Math.round(state.health)}%`;
      endStats.innerHTML =
        `Attempted: <b>${state.attempted}</b><br/>` +
        `Correct: <b>${state.correct}</b><br/>` +
        `Longest streak: <b>${state.bestStreak}</b>`;
    }

    function showFeedback(isCorrect, text){
      feedbackEl.classList.add("show");
      if (isCorrect){
        fbTag.textContent = "Correct";
        fbTag.className = "tag good";
      } else {
        fbTag.textContent = "Wrong";
        fbTag.className = "tag bad";
      }
      fbText.textContent = text;
    }

    function animateHealth(kind){
      healthFill.classList.remove("pulseGood","pulseBad");
      void healthFill.offsetWidth;
      if (kind === "good") healthFill.classList.add("pulseGood");
      else healthFill.classList.add("pulseBad");
    }

    function tinyShake(){
      gameBody.classList.remove("shake");
      void gameBody.offsetWidth;
      gameBody.classList.add("shake");
      setTimeout(()=>gameBody.classList.remove("shake"), 260);
    }

    function openRepairModal(){
      repairNow.textContent = `${Math.round(state.health)}%`;
      repairModal.classList.add("show");
      document.body.style.overflow = "hidden";
    }
    function closeRepairModal(){
      repairModal.classList.remove("show");
      document.body.style.overflow = "";
    }

    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(()=>toast.classList.remove("show"), 2200);
    }

    function saveState(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }
    function loadState(){
      try{
        const raw = localStorage.getItem(STORE_KEY);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch { return null; }
    }

    function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
    function shuffle(arr){
      const a = arr.slice();
      for (let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }
  </script>
</body>
</html>
